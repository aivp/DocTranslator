import{_ as ye,z as be,$ as Ce,r as v,e as D,a0 as xe,f as Te,h as ke,i as m,j as ze,o as d,c as g,a as n,k as c,l as h,w as C,n as N,m as p,p as $e,F as Se,q as Le,E as i,s as J,T as Ve,x as z,V as Ue,a1 as Be,t as w,a2 as P,Y as K,y as De,P as Q,a3 as Ie}from"./index-CAnwEIGi.js";import{g as Re,a as Me,b as Oe,c as je,d as Ee,r as Ne}from"./tools-t5wMzLZS.js";const Pe={class:"image-translate-list-page"},Fe={class:"page-container"},qe={class:"page-header"},Ae={class:"header-left"},He={class:"header-right"},We={class:"filter-bar"},Ye={class:"filter-left"},Ge={class:"filter-right"},Je={class:"task-list"},Ke={key:1,class:"task-items"},Qe={class:"task-header"},Xe={class:"task-checkbox"},Ze={class:"task-info"},et={class:"task-name"},tt={class:"task-meta"},at={class:"task-time"},st={key:0,class:"expired-tag"},nt={class:"task-actions"},lt={class:"task-content"},ot={class:"task-image"},it={class:"image-wrapper"},rt=["src","alt","onClick"],ct={class:"image-actions"},dt={class:"task-details"},ut={class:"detail-row"},gt={class:"value"},ft={class:"value"},vt={key:0,class:"translating-info"},pt={key:1,class:"result-info"},_t={key:0,class:"result-item"},mt={class:"result-text"},ht={key:1,class:"result-item"},wt={class:"result-text translated"},yt={key:2,class:"result-image"},bt={class:"image-wrapper"},Ct=["src","onClick"],xt={class:"image-actions"},Tt={key:2,class:"error-info"},kt={class:"retry-action"},zt={key:3,class:"expired-info"},$t={key:0,class:"pagination-wrapper"},St={class:"preview-content"},Lt=["src"],Vt=3e4,Ut={__name:"list",setup(Bt){const F=be();Ce();const S=v(!1),f=v([]),I=v(0),T=v(1),L=v(10),V=v(""),o=v([]),y=v(!1),$=v([]),q=v(""),R=v(!1);let U=null;const X={zh:"简体中文",en:"英文",ko:"韩语",ja:"日语",ru:"俄语",es:"西班牙语",fr:"法语",pt:"葡萄牙语",it:"意大利语",de:"德语",vi:"越南语",ms:"马来语",th:"泰语",id:"印尼语",ar:"阿拉伯语"};function A(t){return X[t]||t}function Z(t){return{uploaded:"info",translating:"warning",completed:"success",failed:"danger"}[t]||"info"}function ee(t){return{uploaded:"已上传",translating:"翻译中",completed:"已完成",failed:"失败"}[t]||t}function te(t){if(!t)return"";const e=new Date(t),l=new Date-e,r=Math.floor(l/6e4),u=Math.floor(l/36e5),b=Math.floor(l/864e5);return r<1?"刚刚":r<60?`${r}分钟前`:u<24?`${u}小时前`:b<1?"今天 "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}function k(t){if(!t)return!1;const e=new Date(t);return new Date-e>24*60*60*1e3}function M(t){return t?t.startsWith("http://")||t.startsWith("https://")?t:t.includes("/uploads/")?`/uploads/${t.split("/uploads/")[1]}`:t:""}function ae(){o.value=[],y.value=!1,T.value=1,_()}async function _(){S.value=!0;try{const t={page:T.value,limit:L.value};V.value&&(t.status=V.value);const e=await Re(t);if(e.code===200){const a=e.data.data||[],l=a.filter(r=>r.status==="translating"&&r.qwen_task_id);if(l.length>0)for(const r of l)try{const u=await Me(r.id);if(u.code===200){const b=a.findIndex(E=>E.id===r.id);b!==-1&&Object.assign(a[b],u.data)}l.indexOf(r)<l.length-1&&await new Promise(b=>setTimeout(b,100))}catch(u){console.error(`查询任务 ${r.id} 状态失败:`,u)}f.value=a,I.value=e.data.total||0,H()}else i.error(e.message||"加载失败")}catch(t){console.error("加载列表失败:",t),i.error("加载列表失败")}finally{S.value=!1}}function se(t,e){if(e)o.value.includes(t)||o.value.push(t);else{const a=o.value.indexOf(t);a>-1&&o.value.splice(a,1)}H()}function ne(t){t?o.value=f.value.filter(e=>e.status!=="translating").map(e=>e.id):o.value=[]}function H(){const t=f.value.filter(a=>a.status!=="translating");if(t.length===0){y.value=!1;return}const e=o.value.length;y.value=e===t.length}const le=D(()=>o.value.some(t=>{const e=f.value.find(a=>a.id===t);return e&&e.status==="translating"})),oe=D(()=>o.value.some(t=>{const e=f.value.find(a=>a.id===t);return e&&e.status==="completed"&&e.translated_image_url})),ie=D(()=>{const t=f.value.filter(a=>a.status!=="translating");if(t.length===0)return!1;const e=o.value.length;return e>0&&e<t.length});async function re(t){try{await J.confirm("确定要删除这个翻译任务吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await Ee(t);if(e.code===200){i.success("删除成功");const a=o.value.indexOf(t);a>-1&&o.value.splice(a,1),_()}else i.error(e.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除失败:",e),i.error("删除失败"))}}async function ce(t){if(!$.value.includes(t))try{$.value.push(t);const e=await Ne(t);e.code===200?(i.success("重试成功，任务已加入队列"),await _(),j.value&&O()):i.error(e.message||"重试失败")}catch(e){console.error("重试失败:",e),i.error("重试失败，请稍后重试")}finally{const e=$.value.indexOf(t);e>-1&&$.value.splice(e,1)}}function W(t){q.value=t,R.value=!0}function Y(t,e){try{const a=document.createElement("a");a.href=t,a.download=e||"image.png",a.target="_blank",fetch(t).then(l=>l.blob()).then(l=>{const r=window.URL.createObjectURL(l);a.href=r,document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(r),i.success("图片下载成功")}).catch(l=>{console.error("下载图片失败:",l),a.href=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),i.warning("图片下载中，如未自动下载请右键保存")})}catch(a){console.error("下载图片失败:",a),i.error("下载图片失败")}}async function de(){if(o.value.length===0){i.warning("请先选择要下载的任务");return}const t=o.value.filter(e=>{const a=f.value.find(l=>l.id===e);return a&&a.status==="completed"&&a.translated_image_url});if(t.length===0){i.warning("选中的任务中没有已完成的翻译，无法下载");return}try{const e=i({message:"正在打包下载，请稍候...",type:"info",duration:0}),a=await Oe(t);e.close();const l=new Blob([a],{type:"application/zip"}),r=window.URL.createObjectURL(l),u=document.createElement("a");u.href=r,u.download=`translated_images_${new Date().getTime()}.zip`,document.body.appendChild(u),u.click(),document.body.removeChild(u),window.URL.revokeObjectURL(r),i.success(`成功下载${t.length}张翻译后的图片`)}catch(e){console.error("批量下载失败:",e),i.error("批量下载失败，请稍后重试")}}async function ue(){if(o.value.length===0){i.warning("请先选择要删除的任务");return}if(o.value.filter(e=>{const a=f.value.find(l=>l.id===e);return a&&a.status==="translating"}).length>0){i.warning("不能删除正在翻译中的任务");return}try{await J.confirm(`确定要删除选中的 ${o.value.length} 个翻译任务吗？`,"批量删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await je(o.value);if(e.code===200){const{deleted_count:a,failed_count:l,message:r}=e.data;l>0?i.warning(r||`成功删除${a}个，失败${l}个`):i.success(`成功删除${a}个任务`),o.value=[],y.value=!1,_()}else i.error(e.message||"批量删除失败")}catch(e){e!=="cancel"&&(console.error("批量删除失败:",e),i.error("批量删除失败"))}}function ge(t){T.value=t,o.value=[],y.value=!1,_()}function fe(t){L.value=t,T.value=1,o.value=[],y.value=!1,_()}function ve(){F.back()}function pe(){F.push("/tools/image-translate")}function O(){B(),f.value.some(e=>e.status==="translating"&&!k(e.created_at))&&(_(),U=setInterval(()=>{f.value.some(a=>a.status==="translating"&&!k(a.created_at))?_():B()},Vt))}function B(){U&&(clearInterval(U),U=null)}const j=D(()=>f.value.some(t=>t.status==="translating"&&!k(t.created_at)));return xe(j,t=>{t?O():B()}),Te(async()=>{await _(),j.value&&O()}),ke(()=>{B()}),(t,e)=>{const a=m("el-button"),l=m("el-option"),r=m("el-select"),u=m("el-checkbox"),b=m("el-empty"),E=m("el-tag"),_e=m("el-progress"),G=m("el-alert"),me=m("el-pagination"),he=m("el-dialog"),we=ze("loading");return d(),g("div",Pe,[n("div",Fe,[n("div",qe,[n("div",Ae,[c(a,{icon:h(Ve),circle:"",onClick:ve},null,8,["icon"]),e[5]||(e[5]=n("h2",null,"翻译任务列表",-1))]),n("div",He,[c(a,{type:"primary",icon:h(Ue),onClick:pe},{default:C(()=>e[6]||(e[6]=[z("新建翻译",-1)])),_:1,__:[6]},8,["icon"])])]),n("div",We,[n("div",Ye,[c(r,{modelValue:V.value,"onUpdate:modelValue":e[0]||(e[0]=s=>V.value=s),placeholder:"状态筛选",clearable:"",onChange:ae,style:{width:"150px"}},{default:C(()=>[c(l,{label:"全部",value:""}),c(l,{label:"已上传",value:"uploaded"}),c(l,{label:"翻译中",value:"translating"}),c(l,{label:"已完成",value:"completed"}),c(l,{label:"失败",value:"failed"})]),_:1},8,["modelValue"]),c(a,{icon:h(Be),circle:"",onClick:_},null,8,["icon"]),o.value.length>0?(d(),N(a,{key:0,type:"primary",icon:h(P),onClick:de,disabled:!oe.value},{default:C(()=>[z(" 批量下载 ("+w(o.value.length)+") ",1)]),_:1},8,["icon","disabled"])):p("",!0),o.value.length>0?(d(),N(a,{key:1,type:"danger",icon:h(K),onClick:ue,disabled:le.value},{default:C(()=>[z(" 批量删除 ("+w(o.value.length)+") ",1)]),_:1},8,["icon","disabled"])):p("",!0)]),n("div",Ge,[c(u,{modelValue:y.value,"onUpdate:modelValue":e[1]||(e[1]=s=>y.value=s),indeterminate:ie.value,onChange:ne},{default:C(()=>e[7]||(e[7]=[z(" 全选 ",-1)])),_:1,__:[7]},8,["modelValue","indeterminate"])])]),$e((d(),g("div",Je,[!S.value&&f.value.length===0?(d(),N(b,{key:0,description:"暂无翻译任务"})):(d(),g("div",Ke,[(d(!0),g(Se,null,Le(f.value,s=>(d(),g("div",{key:s.id,class:De(["task-item",{"status-uploaded":s.status==="uploaded","status-translating":s.status==="translating","status-completed":s.status==="completed","status-failed":s.status==="failed",expired:k(s.created_at),selected:o.value.includes(s.id)}])},[n("div",Qe,[n("div",Xe,[c(u,{"model-value":o.value.includes(s.id),onChange:x=>se(s.id,x),disabled:s.status==="translating"},null,8,["model-value","onChange","disabled"])]),n("div",Ze,[n("div",et,w(s.original_filename),1),n("div",tt,[c(E,{type:Z(s.status),size:"small"},{default:C(()=>[z(w(ee(s.status)),1)]),_:2},1032,["type"]),n("span",at,w(te(s.created_at)),1),k(s.created_at)?(d(),g("span",st,"已过期")):p("",!0)])]),n("div",nt,[c(a,{type:"danger",icon:h(K),size:"small",circle:"",onClick:x=>re(s.id),disabled:s.status==="translating"},null,8,["icon","onClick","disabled"])])]),n("div",lt,[n("div",ot,[n("div",it,[n("img",{src:M(s.filepath),alt:s.original_filename,class:"task-image-preview",onClick:x=>W(M(s.filepath))},null,8,rt),n("div",ct,[c(a,{type:"primary",icon:h(P),size:"small",circle:"",onClick:Q(x=>Y(M(s.filepath),s.original_filename),["stop"]),title:"下载原图"},null,8,["icon","onClick"])])])]),n("div",dt,[n("div",ut,[e[8]||(e[8]=n("span",{class:"label"},"源语言：",-1)),n("span",gt,w(A(s.source_language)),1),e[9]||(e[9]=n("span",{class:"label",style:{"margin-left":"20px"}},"目标语言：",-1)),n("span",ft,w(A(s.target_language)),1)]),s.status==="translating"?(d(),g("div",vt,[c(_e,{percentage:50,status:null,"show-text":!1}),e[10]||(e[10]=n("span",{class:"translating-text"},"正在翻译中，请稍候...",-1))])):p("",!0),s.status==="completed"?(d(),g("div",pt,[s.original_text?(d(),g("div",_t,[e[11]||(e[11]=n("div",{class:"result-label"},"原文：",-1)),n("div",mt,w(s.original_text),1)])):p("",!0),s.translated_text?(d(),g("div",ht,[e[12]||(e[12]=n("div",{class:"result-label"},"译文：",-1)),n("div",wt,w(s.translated_text),1)])):p("",!0),s.translated_image_url?(d(),g("div",yt,[e[13]||(e[13]=n("div",{class:"result-label"},"翻译后图片：",-1)),n("div",bt,[n("img",{src:s.translated_image_url,alt:"翻译后的图片",class:"result-image-preview",onClick:x=>W(s.translated_image_url)},null,8,Ct),n("div",xt,[c(a,{type:"primary",icon:h(P),size:"small",circle:"",onClick:Q(x=>Y(s.translated_image_url,`${s.original_filename.replace(/\.[^/.]+$/,"")}_translated.png`),["stop"]),title:"下载翻译后的图片"},null,8,["icon","onClick"])])])])):p("",!0)])):p("",!0),s.status==="failed"?(d(),g("div",Tt,[c(G,{title:s.error_message||"翻译失败",type:"error",closable:!1,"show-icon":""},null,8,["title"]),n("div",kt,[c(a,{type:"primary",size:"small",icon:h(Ie),onClick:x=>ce(s.id),loading:$.value.includes(s.id)},{default:C(()=>e[14]||(e[14]=[z(" 重试 ",-1)])),_:2,__:[14]},1032,["icon","onClick","loading"])])])):p("",!0),k(s.created_at)?(d(),g("div",zt,[c(G,{title:"此任务已超过24小时，结果可能已失效",type:"warning",closable:!1,"show-icon":""})])):p("",!0)])])],2))),128))]))])),[[we,S.value]]),I.value>0?(d(),g("div",$t,[c(me,{"current-page":T.value,"onUpdate:currentPage":e[2]||(e[2]=s=>T.value=s),"page-size":L.value,"onUpdate:pageSize":e[3]||(e[3]=s=>L.value=s),total:I.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:fe,onCurrentChange:ge},null,8,["current-page","page-size","total"])])):p("",!0)]),c(he,{modelValue:R.value,"onUpdate:modelValue":e[4]||(e[4]=s=>R.value=s),title:"图片预览",width:"90%","close-on-click-modal":!0,"align-center":"",class:"image-preview-dialog"},{default:C(()=>[n("div",St,[n("img",{src:q.value,alt:"预览图片",class:"preview-full-image"},null,8,Lt)])]),_:1},8,["modelValue"])])}}},Rt=ye(Ut,[["__scopeId","data-v-1d28a98d"]]);export{Rt as default};
