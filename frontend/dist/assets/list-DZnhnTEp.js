import{_ as be,z as Ce,a1 as Te,r as v,e as N,a2 as xe,f as $e,h as ke,i as w,j as ze,o as u,c as f,a as n,k as d,l as b,w as x,n as q,m as _,p as Le,F as Ue,q as Ve,E as r,s as Q,V as De,x as U,X as Pe,a3 as Se,t as C,a4 as F,$ as Y,y as Be,P as ee,a5 as Ie}from"./index-BSHXqKsI.js";import{g as Ne,a as Me,b as je,c as Oe,d as Re,r as Ee}from"./tools-CM5rLRYv.js";const We={class:"image-translate-list-page"},qe={class:"page-container"},Fe={class:"page-header"},Ae={class:"header-left"},He={class:"header-right"},Ze={class:"filter-bar"},Xe={class:"filter-left"},Ge={class:"filter-right"},Je={class:"task-list"},Ke={key:1,class:"task-items"},Qe={class:"task-header"},Ye={class:"task-checkbox"},et={class:"task-info"},tt={class:"task-name"},at={class:"task-meta"},st={class:"task-time"},nt={key:0,class:"expired-tag"},lt={class:"task-actions"},ot={class:"task-content"},it={class:"task-image"},rt={class:"image-wrapper"},ct=["src","alt","onClick"],dt={class:"image-actions"},ut={class:"task-details"},gt={class:"detail-row"},ft={class:"value"},pt={class:"value"},vt={key:0,class:"translating-info"},_t={key:1,class:"result-info"},mt={key:0,class:"result-item"},ht={class:"result-text"},wt={key:1,class:"result-item"},yt={class:"result-text translated"},bt={key:2,class:"result-image"},Ct={class:"image-wrapper"},Tt=["src","onClick"],xt={class:"image-actions"},$t={key:2,class:"error-info"},kt={class:"retry-action"},zt={key:3,class:"expired-info"},Lt={key:0,class:"pagination-wrapper"},Ut={class:"preview-content"},Vt=["src"],Dt=3e4,Pt={__name:"list",setup(St){const A=Ce();Te();const D=v(!1),p=v([]),M=v(0),L=v(1),P=v(10),S=v(""),o=v([]),T=v(!1),V=v([]),H=v(""),j=v(!1);let B=null;const te={zh:"简体中文",en:"英文",ko:"韩语",ja:"日语",ru:"俄语",es:"西班牙语",fr:"法语",pt:"葡萄牙语",it:"意大利语",de:"德语",vi:"越南语",ms:"马来语",th:"泰语",id:"印尼语",ar:"阿拉伯语"};function Z(t){return te[t]||t}function ae(t){return{uploaded:"info",translating:"warning",completed:"success",failed:"danger"}[t]||"info"}function se(t){return{uploaded:"已上传",translating:"翻译中",completed:"已完成",failed:"失败"}[t]||t}function X(t){if(!t)return null;if(typeof t=="string"){const e=t.trim(),a=/^\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}:\d{2}/,l=e.endsWith("Z")||/[+-]\d{2}:?\d{2}$/.test(e)||/[+-]\d{2}$/.test(e);if(a.test(e)&&!l){const c=e.replace(" ","T")+"Z";return new Date(c)}else return new Date(e)}else return new Date(t)}function ne(t){if(!t)return"";const e=X(t);if(!e||isNaN(e.getTime()))return t;const l=new Date-e,c=Math.floor(l/6e4),i=Math.floor(l/36e5),g=Math.floor(l/864e5);return c<1?"刚刚":c<60?`${c}分钟前`:i<24?`${i}小时前`:g<1?"今天 "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}function $(t){if(!t)return!1;const e=X(t);return!e||isNaN(e.getTime())?!1:new Date-e>24*60*60*1e3}function O(t){return t?t.startsWith("http://")||t.startsWith("https://")?t:t.includes("/uploads/")?`/uploads/${t.split("/uploads/")[1]}`:t:""}function le(){o.value=[],T.value=!1,L.value=1,m()}async function m(){D.value=!0;try{const t={page:L.value,limit:P.value};S.value&&(t.status=S.value);const e=await Ne(t);if(e.code===200){const a=e.data.data||[],l=a.filter(c=>(c.status==="uploaded"||c.status==="translating")&&!$(c.created_at));if(l.length>0){const c=async(i,g=3)=>{for(let h=1;h<=g;h++)try{const k=await Me(i.id);if(k.code===200){const y=a.findIndex(W=>W.id===i.id);return y!==-1&&Object.assign(a[y],k.data),!0}else console.warn(`查询任务 ${i.id} 状态失败 (尝试 ${h}/${g}):`,k.message),h<g&&await new Promise(y=>setTimeout(y,1e3))}catch(k){console.error(`查询任务 ${i.id} 状态失败 (尝试 ${h}/${g}):`,k),h<g&&await new Promise(y=>setTimeout(y,1e3))}return console.error(`查询任务 ${i.id} 状态失败，已重试 ${g} 次，跳过该任务`),!1};for(let i=0;i<l.length;i++){const g=l[i];g.status==="translating"&&g.qwen_task_id&&(await c(g,3),i<l.length-1&&await new Promise(h=>setTimeout(h,1e3)))}}p.value=a,M.value=e.data.total||0,G()}else r.error(e.message||"加载失败")}catch(t){console.error("加载列表失败:",t),r.error("加载列表失败")}finally{D.value=!1}}function oe(t,e){if(e)o.value.includes(t)||o.value.push(t);else{const a=o.value.indexOf(t);a>-1&&o.value.splice(a,1)}G()}function ie(t){t?o.value=p.value.filter(e=>e.status!=="translating").map(e=>e.id):o.value=[]}function G(){const t=p.value.filter(a=>a.status!=="translating");if(t.length===0){T.value=!1;return}const e=o.value.length;T.value=e===t.length}const re=N(()=>o.value.some(t=>{const e=p.value.find(a=>a.id===t);return e&&e.status==="translating"})),ce=N(()=>o.value.some(t=>{const e=p.value.find(a=>a.id===t);return e&&e.status==="completed"&&e.translated_image_url})),de=N(()=>{const t=p.value.filter(a=>a.status!=="translating");if(t.length===0)return!1;const e=o.value.length;return e>0&&e<t.length});async function ue(t){try{await Q.confirm("确定要删除这个翻译任务吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await Re(t);if(e.code===200){r.success("删除成功");const a=o.value.indexOf(t);a>-1&&o.value.splice(a,1),m()}else r.error(e.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除失败:",e),r.error("删除失败"))}}async function ge(t){if(!V.value.includes(t))try{V.value.push(t);const e=await Ee(t);e.code===200?(r.success("重试成功，任务已加入队列"),await m(),E.value&&R()):r.error(e.message||"重试失败")}catch(e){console.error("重试失败:",e),r.error("重试失败，请稍后重试")}finally{const e=V.value.indexOf(t);e>-1&&V.value.splice(e,1)}}function J(t){H.value=t,j.value=!0}function K(t,e){try{const a=document.createElement("a");a.href=t,a.download=e||"image.png",a.target="_blank",fetch(t).then(l=>l.blob()).then(l=>{const c=window.URL.createObjectURL(l);a.href=c,document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(c),r.success("图片下载成功")}).catch(l=>{console.error("下载图片失败:",l),a.href=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),r.warning("图片下载中，如未自动下载请右键保存")})}catch(a){console.error("下载图片失败:",a),r.error("下载图片失败")}}async function fe(){if(o.value.length===0){r.warning("请先选择要下载的任务");return}const t=o.value.filter(e=>{const a=p.value.find(l=>l.id===e);return a&&a.status==="completed"&&a.translated_image_url});if(t.length===0){r.warning("选中的任务中没有已完成的翻译，无法下载");return}try{const e=r({message:"正在打包下载，请稍候...",type:"info",duration:0}),a=await je(t);e.close();const l=new Blob([a],{type:"application/zip"}),c=window.URL.createObjectURL(l),i=document.createElement("a");i.href=c,i.download=`translated_images_${new Date().getTime()}.zip`,document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(c),r.success(`成功下载${t.length}张翻译后的图片`)}catch(e){console.error("批量下载失败:",e),r.error("批量下载失败，请稍后重试")}}async function pe(){if(o.value.length===0){r.warning("请先选择要删除的任务");return}if(o.value.filter(e=>{const a=p.value.find(l=>l.id===e);return a&&a.status==="translating"}).length>0){r.warning("不能删除正在翻译中的任务");return}try{await Q.confirm(`确定要删除选中的 ${o.value.length} 个翻译任务吗？`,"批量删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await Oe(o.value);if(e.code===200){const{deleted_count:a,failed_count:l,message:c}=e.data;l>0?r.warning(c||`成功删除${a}个，失败${l}个`):r.success(`成功删除${a}个任务`),o.value=[],T.value=!1,m()}else r.error(e.message||"批量删除失败")}catch(e){e!=="cancel"&&(console.error("批量删除失败:",e),r.error("批量删除失败"))}}function ve(t){L.value=t,o.value=[],T.value=!1,m()}function _e(t){P.value=t,L.value=1,o.value=[],T.value=!1,m()}function me(){A.back()}function he(){A.push("/tools/image-translate")}function R(){I(),p.value.some(e=>(e.status==="translating"||e.status==="uploaded")&&!$(e.created_at))&&(m(),B=setInterval(()=>{p.value.some(a=>(a.status==="translating"||a.status==="uploaded")&&!$(a.created_at))?m():I()},Dt))}function I(){B&&(clearInterval(B),B=null)}const E=N(()=>p.value.some(t=>(t.status==="translating"||t.status==="uploaded")&&!$(t.created_at)));return xe(E,t=>{t?R():I()}),$e(async()=>{await m(),E.value&&R()}),ke(()=>{I()}),(t,e)=>{const a=w("el-button"),l=w("el-option"),c=w("el-select"),i=w("el-checkbox"),g=w("el-empty"),h=w("el-tag"),k=w("el-progress"),y=w("el-alert"),W=w("el-pagination"),we=w("el-dialog"),ye=ze("loading");return u(),f("div",We,[n("div",qe,[n("div",Fe,[n("div",Ae,[d(a,{icon:b(De),circle:"",onClick:me},null,8,["icon"]),e[5]||(e[5]=n("h2",null,"翻译任务列表",-1))]),n("div",He,[d(a,{type:"primary",icon:b(Pe),onClick:he},{default:x(()=>e[6]||(e[6]=[U("新建翻译",-1)])),_:1,__:[6]},8,["icon"])])]),n("div",Ze,[n("div",Xe,[d(c,{modelValue:S.value,"onUpdate:modelValue":e[0]||(e[0]=s=>S.value=s),placeholder:"状态筛选",clearable:"",onChange:le,style:{width:"150px"}},{default:x(()=>[d(l,{label:"全部",value:""}),d(l,{label:"已上传",value:"uploaded"}),d(l,{label:"翻译中",value:"translating"}),d(l,{label:"已完成",value:"completed"}),d(l,{label:"失败",value:"failed"})]),_:1},8,["modelValue"]),d(a,{icon:b(Se),circle:"",onClick:m},null,8,["icon"]),o.value.length>0?(u(),q(a,{key:0,type:"primary",icon:b(F),onClick:fe,disabled:!ce.value},{default:x(()=>[U(" 批量下载 ("+C(o.value.length)+") ",1)]),_:1},8,["icon","disabled"])):_("",!0),o.value.length>0?(u(),q(a,{key:1,type:"danger",icon:b(Y),onClick:pe,disabled:re.value},{default:x(()=>[U(" 批量删除 ("+C(o.value.length)+") ",1)]),_:1},8,["icon","disabled"])):_("",!0)]),n("div",Ge,[d(i,{modelValue:T.value,"onUpdate:modelValue":e[1]||(e[1]=s=>T.value=s),indeterminate:de.value,onChange:ie},{default:x(()=>e[7]||(e[7]=[U(" 全选 ",-1)])),_:1,__:[7]},8,["modelValue","indeterminate"])])]),Le((u(),f("div",Je,[!D.value&&p.value.length===0?(u(),q(g,{key:0,description:"暂无翻译任务"})):(u(),f("div",Ke,[(u(!0),f(Ue,null,Ve(p.value,s=>(u(),f("div",{key:s.id,class:Be(["task-item",{"status-uploaded":s.status==="uploaded","status-translating":s.status==="translating","status-completed":s.status==="completed","status-failed":s.status==="failed",expired:$(s.created_at),selected:o.value.includes(s.id)}])},[n("div",Qe,[n("div",Ye,[d(i,{"model-value":o.value.includes(s.id),onChange:z=>oe(s.id,z),disabled:s.status==="translating"},null,8,["model-value","onChange","disabled"])]),n("div",et,[n("div",tt,C(s.original_filename),1),n("div",at,[d(h,{type:ae(s.status),size:"small"},{default:x(()=>[U(C(se(s.status)),1)]),_:2},1032,["type"]),n("span",st,C(ne(s.created_at)),1),$(s.created_at)?(u(),f("span",nt,"已过期")):_("",!0)])]),n("div",lt,[d(a,{type:"danger",icon:b(Y),size:"small",circle:"",onClick:z=>ue(s.id),disabled:s.status==="translating"},null,8,["icon","onClick","disabled"])])]),n("div",ot,[n("div",it,[n("div",rt,[n("img",{src:O(s.filepath),alt:s.original_filename,class:"task-image-preview",onClick:z=>J(O(s.filepath))},null,8,ct),n("div",dt,[d(a,{type:"primary",icon:b(F),size:"small",circle:"",onClick:ee(z=>K(O(s.filepath),s.original_filename),["stop"]),title:"下载原图"},null,8,["icon","onClick"])])])]),n("div",ut,[n("div",gt,[e[8]||(e[8]=n("span",{class:"label"},"源语言：",-1)),n("span",ft,C(Z(s.source_language)),1),e[9]||(e[9]=n("span",{class:"label",style:{"margin-left":"20px"}},"目标语言：",-1)),n("span",pt,C(Z(s.target_language)),1)]),s.status==="translating"?(u(),f("div",vt,[d(k,{percentage:50,status:null,"show-text":!1}),e[10]||(e[10]=n("span",{class:"translating-text"},"正在翻译中，请稍候...",-1))])):_("",!0),s.status==="completed"?(u(),f("div",_t,[s.original_text?(u(),f("div",mt,[e[11]||(e[11]=n("div",{class:"result-label"},"原文：",-1)),n("div",ht,C(s.original_text),1)])):_("",!0),s.translated_text?(u(),f("div",wt,[e[12]||(e[12]=n("div",{class:"result-label"},"译文：",-1)),n("div",yt,C(s.translated_text),1)])):_("",!0),s.translated_image_url?(u(),f("div",bt,[e[13]||(e[13]=n("div",{class:"result-label"},"翻译后图片：",-1)),n("div",Ct,[n("img",{src:s.translated_image_url,alt:"翻译后的图片",class:"result-image-preview",onClick:z=>J(s.translated_image_url)},null,8,Tt),n("div",xt,[d(a,{type:"primary",icon:b(F),size:"small",circle:"",onClick:ee(z=>K(s.translated_image_url,`${s.original_filename.replace(/\.[^/.]+$/,"")}_translated.png`),["stop"]),title:"下载翻译后的图片"},null,8,["icon","onClick"])])])])):_("",!0)])):_("",!0),s.status==="failed"?(u(),f("div",$t,[d(y,{title:s.error_message||"翻译失败",type:"error",closable:!1,"show-icon":""},null,8,["title"]),n("div",kt,[d(a,{type:"primary",size:"small",icon:b(Ie),onClick:z=>ge(s.id),loading:V.value.includes(s.id)},{default:x(()=>e[14]||(e[14]=[U(" 重试 ",-1)])),_:2,__:[14]},1032,["icon","onClick","loading"])])])):_("",!0),$(s.created_at)?(u(),f("div",zt,[d(y,{title:"此任务已超过24小时，结果可能已失效",type:"warning",closable:!1,"show-icon":""})])):_("",!0)])])],2))),128))]))])),[[ye,D.value]]),M.value>0?(u(),f("div",Lt,[d(W,{"current-page":L.value,"onUpdate:currentPage":e[2]||(e[2]=s=>L.value=s),"page-size":P.value,"onUpdate:pageSize":e[3]||(e[3]=s=>P.value=s),total:M.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:_e,onCurrentChange:ve},null,8,["current-page","page-size","total"])])):_("",!0)]),d(we,{modelValue:j.value,"onUpdate:modelValue":e[4]||(e[4]=s=>j.value=s),title:"图片预览",width:"90%","close-on-click-modal":!0,"align-center":"",class:"image-preview-dialog"},{default:x(()=>[n("div",Ut,[n("img",{src:H.value,alt:"预览图片",class:"preview-full-image"},null,8,Vt)])]),_:1},8,["modelValue"])])}}},Nt=be(Pt,[["__scopeId","data-v-34dcd41c"]]);export{Nt as default};
